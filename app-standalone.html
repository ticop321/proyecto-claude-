<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo Circadiano Pro - Dashboard</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: white;
            border-right: 1px solid var(--border);
            padding: 20px 0;
            overflow-y: auto;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo h2 {
            color: var(--primary);
            font-size: 1.3em;
        }

        .logo p {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #475569;
        }

        .nav-item:hover {
            background: var(--light);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            border-right: 3px solid var(--primary-dark);
        }

        .nav-icon {
            font-size: 1.2em;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 30px;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .stat-card.sleep {
            border-left-color: var(--primary);
        }

        .stat-card.supplements {
            border-left-color: var(--success);
        }

        .stat-card.exercise {
            border-left-color: var(--warning);
        }

        .stat-card.health {
            border-left-color: var(--danger);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 0.9em;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            font-size: 1.5em;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #64748b;
        }

        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85em;
            margin-top: 10px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .stat-trend.up {
            background: #dcfce7;
            color: #16a34a;
        }

        .stat-trend.down {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Content Section */
        .content-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .section-title {
            font-size: 1.4em;
            color: var(--dark);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--light);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:hover {
            background: var(--light);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .badge-success {
            background: #dcfce7;
            color: #16a34a;
        }

        .badge-warning {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 20px;
            background: white;
            border: 2px dashed var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .action-btn:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .action-btn-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #64748b;
        }

        .close-btn:hover {
            color: var(--dark);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
            z-index: 2000;
            display: none;
            border-left: 4px solid;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding-left: 25px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -36px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--border);
        }

        .timeline-time {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .timeline-content {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
                z-index: 100;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h2>üåô Protocolo Pro</h2>
            <p>Gesti√≥n Circadiana</p>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" data-view="dashboard">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-view="sleep">
                <span class="nav-icon">üò¥</span>
                <span>Sue√±o</span>
            </div>
            <div class="nav-item" data-view="supplements">
                <span class="nav-icon">üíä</span>
                <span>Suplementos</span>
            </div>
            <div class="nav-item" data-view="exercise">
                <span class="nav-icon">üèÉ</span>
                <span>Ejercicio</span>
            </div>
            <div class="nav-item" data-view="health">
                <span class="nav-icon">ü´Ä</span>
                <span>Salud</span>
            </div>
            <div class="nav-item" data-view="protocol">
                <span class="nav-icon">üìã</span>
                <span>Protocolo</span>
            </div>
            <div class="nav-item" data-view="reports">
                <span class="nav-icon">üìà</span>
                <span>Reportes</span>
            </div>
            <div class="nav-item" data-view="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Configuraci√≥n</span>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div>
                <h1 id="view-title">Dashboard</h1>
                <p id="current-date"></p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="app.exportData()">üì• Exportar</button>
                <button class="btn btn-primary" onclick="app.showQuickLog()">‚ûï Registro R√°pido</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card sleep">
                    <div class="stat-header">
                        <span class="stat-title">Sue√±o Promedio</span>
                        <span class="stat-icon">üò¥</span>
                    </div>
                    <div class="stat-value" id="avg-sleep">7.5h</div>
                    <div class="stat-label">√öltimos 7 d√≠as</div>
                    <div class="stat-trend up">
                        <span>‚Üë</span> <span>+0.5h vs. semana anterior</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 94%"></div>
                    </div>
                </div>

                <div class="stat-card supplements">
                    <div class="stat-header">
                        <span class="stat-title">Adherencia Suplementos</span>
                        <span class="stat-icon">üíä</span>
                    </div>
                    <div class="stat-value" id="supplement-adherence">85%</div>
                    <div class="stat-label">Esta semana</div>
                    <div class="stat-trend up">
                        <span>‚Üë</span> <span>+5% vs. semana anterior</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 85%"></div>
                    </div>
                </div>

                <div class="stat-card exercise">
                    <div class="stat-header">
                        <span class="stat-title">Ejercicio Semanal</span>
                        <span class="stat-icon">üèÉ</span>
                    </div>
                    <div class="stat-value" id="exercise-count">4/5</div>
                    <div class="stat-label">D√≠as completados</div>
                    <div class="stat-trend up">
                        <span>‚Üë</span> <span>+1 d√≠a vs. semana anterior</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 80%"></div>
                    </div>
                </div>

                <div class="stat-card health">
                    <div class="stat-header">
                        <span class="stat-title">Calidad General</span>
                        <span class="stat-icon">‚ù§Ô∏è</span>
                    </div>
                    <div class="stat-value" id="health-score">8.2/10</div>
                    <div class="stat-label">Score de bienestar</div>
                    <div class="stat-trend up">
                        <span>‚Üë</span> <span>+0.3 puntos</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 82%"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Acciones R√°pidas</h3>
                </div>
                <div class="quick-actions">
                    <div class="action-btn" onclick="app.logSleep()">
                        <div class="action-btn-icon">üò¥</div>
                        <div>Registrar Sue√±o</div>
                    </div>
                    <div class="action-btn" onclick="app.logSupplements()">
                        <div class="action-btn-icon">üíä</div>
                        <div>Tomar Suplementos</div>
                    </div>
                    <div class="action-btn" onclick="app.logExercise()">
                        <div class="action-btn-icon">üèÉ</div>
                        <div>Registrar Ejercicio</div>
                    </div>
                    <div class="action-btn" onclick="app.logHealth()">
                        <div class="action-btn-icon">ü´Ä</div>
                        <div>M√©tricas Salud</div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Actividad Reciente</h3>
                    <button class="btn btn-secondary" onclick="app.viewAll('activity')">Ver Todo</button>
                </div>
                <div class="timeline" id="recent-activity">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Charts -->
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Tendencias (√öltima Semana)</h3>
                </div>
                <div class="chart-container">
                    <canvas id="trends-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Other views will be populated by JavaScript -->
        <div id="sleep-view" class="view hidden"></div>
        <div id="supplements-view" class="view hidden"></div>
        <div id="exercise-view" class="view hidden"></div>
        <div id="health-view" class="view hidden"></div>
        <div id="protocol-view" class="view hidden"></div>
        <div id="reports-view" class="view hidden"></div>
        <div id="settings-view" class="view hidden"></div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Modal</h3>
                <button class="close-btn" onclick="app.closeModal()">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <div id="notification-content"></div>
    </div>

    <script src="app-database.js"></script>
    <script>
// Database Manager - IndexedDB para almacenamiento local
class CircadianDB {
    constructor() {
        this.dbName = 'CircadianProtocolDB';
        this.version = 1;
        this.db = null;
    }

    // Inicializar base de datos
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);

            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve(this.db);
            };

            request.onupgradeneeded = (event) => {
                const db = event.target.result;

                // Store para registros de sue√±o
                if (!db.objectStoreNames.contains('sleep')) {
                    const sleepStore = db.createObjectStore('sleep', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    sleepStore.createIndex('date', 'date', { unique: false });
                }

                // Store para suplementos
                if (!db.objectStoreNames.contains('supplements')) {
                    const suppStore = db.createObjectStore('supplements', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    suppStore.createIndex('date', 'date', { unique: false });
                }

                // Store para ejercicio
                if (!db.objectStoreNames.contains('exercise')) {
                    const exStore = db.createObjectStore('exercise', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    exStore.createIndex('date', 'date', { unique: false });
                }

                // Store para m√©tricas de salud
                if (!db.objectStoreNames.contains('health')) {
                    const healthStore = db.createObjectStore('health', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    healthStore.createIndex('date', 'date', { unique: false });
                }

                // Store para notas/diario
                if (!db.objectStoreNames.contains('notes')) {
                    const notesStore = db.createObjectStore('notes', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    notesStore.createIndex('date', 'date', { unique: false });
                }

                // Store para configuraci√≥n
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
            };
        });
    }

    // M√©todos gen√©ricos
    async add(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.add(data);

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async getAll(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async getByDate(storeName, date) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const index = store.index('date');
            const request = index.getAll(date);

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async getByDateRange(storeName, startDate, endDate) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const index = store.index('date');
            const range = IDBKeyRange.bound(startDate, endDate);
            const request = index.getAll(range);

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async update(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put(data);

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async delete(storeName, id) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.delete(id);

            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    // M√©todos espec√≠ficos para Sue√±o
    async addSleepLog(data) {
        const sleepData = {
            date: data.date || new Date().toISOString().split('T')[0],
            bedTime: data.bedTime,
            wakeTime: data.wakeTime,
            duration: data.duration, // en minutos
            quality: data.quality, // 1-10
            interruptions: data.interruptions || 0,
            notes: data.notes || '',
            timestamp: new Date().toISOString()
        };
        return await this.add('sleep', sleepData);
    }

    async getSleepStats(days = 7) {
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
            .toISOString().split('T')[0];

        const logs = await this.getByDateRange('sleep', startDate, endDate);

        if (logs.length === 0) return null;

        const avgDuration = logs.reduce((sum, log) => sum + log.duration, 0) / logs.length;
        const avgQuality = logs.reduce((sum, log) => sum + log.quality, 0) / logs.length;

        return {
            avgDuration: Math.round(avgDuration),
            avgQuality: avgQuality.toFixed(1),
            totalLogs: logs.length,
            logs: logs
        };
    }

    // M√©todos espec√≠ficos para Suplementos
    async addSupplementLog(data) {
        const suppData = {
            date: data.date || new Date().toISOString().split('T')[0],
            supplements: data.supplements, // array de nombres
            time: data.time,
            taken: data.taken !== false, // boolean
            notes: data.notes || '',
            timestamp: new Date().toISOString()
        };
        return await this.add('supplements', suppData);
    }

    async getSupplementAdherence(days = 7) {
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
            .toISOString().split('T')[0];

        const logs = await this.getByDateRange('supplements', startDate, endDate);

        if (logs.length === 0) return 0;

        const taken = logs.filter(log => log.taken).length;
        return Math.round((taken / logs.length) * 100);
    }

    // M√©todos espec√≠ficos para Ejercicio
    async addExerciseLog(data) {
        const exData = {
            date: data.date || new Date().toISOString().split('T')[0],
            type: data.type, // 'cardio', 'strength', 'flexibility'
            duration: data.duration, // en minutos
            intensity: data.intensity, // 'low', 'medium', 'high'
            notes: data.notes || '',
            timestamp: new Date().toISOString()
        };
        return await this.add('exercise', exData);
    }

    async getExerciseStats(days = 7) {
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
            .toISOString().split('T')[0];

        const logs = await this.getByDateRange('exercise', startDate, endDate);

        const uniqueDays = new Set(logs.map(log => log.date)).size;
        const totalDuration = logs.reduce((sum, log) => sum + log.duration, 0);

        return {
            daysExercised: uniqueDays,
            totalMinutes: totalDuration,
            totalSessions: logs.length,
            logs: logs
        };
    }

    // M√©todos espec√≠ficos para Salud
    async addHealthLog(data) {
        const healthData = {
            date: data.date || new Date().toISOString().split('T')[0],
            weight: data.weight || null,
            bloodPressure: data.bloodPressure || null, // { systolic, diastolic }
            heartRate: data.heartRate || null,
            mood: data.mood || null, // 1-10
            energy: data.energy || null, // 1-10
            stress: data.stress || null, // 1-10
            symptoms: data.symptoms || [], // array de strings
            notes: data.notes || '',
            timestamp: new Date().toISOString()
        };
        return await this.add('health', healthData);
    }

    async getHealthTrends(days = 7) {
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
            .toISOString().split('T')[0];

        const logs = await this.getByDateRange('health', startDate, endDate);

        if (logs.length === 0) return null;

        const avgMood = logs.filter(l => l.mood).reduce((sum, l) => sum + l.mood, 0) /
            logs.filter(l => l.mood).length || 0;
        const avgEnergy = logs.filter(l => l.energy).reduce((sum, l) => sum + l.energy, 0) /
            logs.filter(l => l.energy).length || 0;
        const avgStress = logs.filter(l => l.stress).reduce((sum, l) => sum + l.stress, 0) /
            logs.filter(l => l.stress).length || 0;

        return {
            avgMood: avgMood.toFixed(1),
            avgEnergy: avgEnergy.toFixed(1),
            avgStress: avgStress.toFixed(1),
            logs: logs
        };
    }

    // M√©todo para obtener todas las m√©tricas del d√≠a
    async getDailyMetrics(date) {
        date = date || new Date().toISOString().split('T')[0];

        const [sleep, supplements, exercise, health] = await Promise.all([
            this.getByDate('sleep', date),
            this.getByDate('supplements', date),
            this.getByDate('exercise', date),
            this.getByDate('health', date)
        ]);

        return {
            date,
            sleep: sleep[0] || null,
            supplements: supplements,
            exercise: exercise,
            health: health[0] || null
        };
    }

    // Exportar todos los datos
    async exportAllData() {
        const [sleep, supplements, exercise, health, notes] = await Promise.all([
            this.getAll('sleep'),
            this.getAll('supplements'),
            this.getAll('exercise'),
            this.getAll('health'),
            this.getAll('notes')
        ]);

        return {
            exportDate: new Date().toISOString(),
            version: this.version,
            data: {
                sleep,
                supplements,
                exercise,
                health,
                notes
            }
        };
    }

    // Importar datos
    async importData(jsonData) {
        try {
            const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;

            for (const [storeName, records] of Object.entries(data.data)) {
                for (const record of records) {
                    delete record.id; // Remove ID to allow auto-increment
                    await this.add(storeName, record);
                }
            }

            return true;
        } catch (error) {
            console.error('Error importing data:', error);
            return false;
        }
    }

    // Limpiar toda la base de datos
    async clearAll() {
        const stores = ['sleep', 'supplements', 'exercise', 'health', 'notes'];

        for (const storeName of stores) {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            await new Promise((resolve, reject) => {
                const request = store.clear();
                request.onsuccess = resolve;
                request.onerror = () => reject(request.error);
            });
        }
    }

    // Obtener configuraci√≥n
    async getSetting(key) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            const request = store.get(key);

            request.onsuccess = () => resolve(request.result?.value || null);
            request.onerror = () => reject(request.error);
        });
    }

    // Guardar configuraci√≥n
    async saveSetting(key, value) {
        return await this.update('settings', { key, value });
    }
}

// Inicializar base de datos global
const db = new CircadianDB();

// Inicializar cuando se cargue el DOM
if (typeof window !== 'undefined') {
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            await db.init();
            console.log('‚úÖ Base de datos inicializada');
        } catch (error) {
            console.error('‚ùå Error al inicializar base de datos:', error);
        }
    });
}
    </script>

    <script>
// Aplicaci√≥n Principal - Protocolo Circadiano Pro
class CircadianApp {
    constructor() {
        this.currentView = 'dashboard';
        this.charts = {};
        this.notificationTimeout = null;
    }

    async init() {
        // Esperar a que la base de datos est√© lista
        await new Promise(resolve => {
            if (db.db) {
                resolve();
            } else {
                setTimeout(resolve, 100);
            }
        });

        this.setupEventListeners();
        this.updateCurrentDate();
        await this.loadDashboard();
        await this.checkNotifications();

        // Actualizar fecha cada minuto
        setInterval(() => this.updateCurrentDate(), 60000);

        // Verificar notificaciones cada 5 minutos
        setInterval(() => this.checkNotifications(), 300000);

        console.log('‚úÖ Aplicaci√≥n inicializada');
    }

    setupEventListeners() {
        // Navegaci√≥n
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const view = e.currentTarget.dataset.view;
                this.switchView(view);
            });
        });

        // Cerrar modal al hacer clic fuera
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                this.closeModal();
            }
        });
    }

    updateCurrentDate() {
        const now = new Date();
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        };
        document.getElementById('current-date').textContent =
            now.toLocaleDateString('es-ES', options);
    }

    switchView(viewName) {
        // Actualizar navegaci√≥n
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.view === viewName) {
                item.classList.add('active');
            }
        });

        // Ocultar todas las vistas
        document.querySelectorAll('.view').forEach(view => {
            view.classList.add('hidden');
        });

        // Mostrar vista seleccionada
        const view = document.getElementById(`${viewName}-view`);
        if (view) {
            view.classList.remove('hidden');
        }

        // Actualizar t√≠tulo
        const titles = {
            dashboard: 'Dashboard',
            sleep: 'Registro de Sue√±o',
            supplements: 'Control de Suplementos',
            exercise: 'Ejercicio y Actividad',
            health: 'M√©tricas de Salud',
            protocol: 'Protocolo Circadiano',
            reports: 'Reportes y An√°lisis',
            settings: 'Configuraci√≥n'
        };
        document.getElementById('view-title').textContent = titles[viewName] || viewName;

        this.currentView = viewName;

        // Cargar contenido espec√≠fico de la vista
        this.loadView(viewName);
    }

    async loadView(viewName) {
        switch (viewName) {
            case 'dashboard':
                await this.loadDashboard();
                break;
            case 'sleep':
                await this.loadSleepView();
                break;
            case 'supplements':
                await this.loadSupplementsView();
                break;
            case 'exercise':
                await this.loadExerciseView();
                break;
            case 'health':
                await this.loadHealthView();
                break;
            case 'protocol':
                await this.loadProtocolView();
                break;
            case 'reports':
                await this.loadReportsView();
                break;
            case 'settings':
                await this.loadSettingsView();
                break;
        }
    }

    // ==================== DASHBOARD ====================
    async loadDashboard() {
        try {
            // Cargar estad√≠sticas
            const [sleepStats, suppAdherence, exStats, healthTrends] = await Promise.all([
                db.getSleepStats(7),
                db.getSupplementAdherence(7),
                db.getExerciseStats(7),
                db.getHealthTrends(7)
            ]);

            // Actualizar tarjetas de estad√≠sticas
            if (sleepStats) {
                const hours = Math.floor(sleepStats.avgDuration / 60);
                const minutes = sleepStats.avgDuration % 60;
                document.getElementById('avg-sleep').textContent = `${hours}.${Math.round(minutes / 6)}h`;
            }

            document.getElementById('supplement-adherence').textContent = `${suppAdherence}%`;

            if (exStats) {
                document.getElementById('exercise-count').textContent =
                    `${exStats.daysExercised}/5`;
            }

            if (healthTrends) {
                const score = ((parseFloat(healthTrends.avgMood) +
                    parseFloat(healthTrends.avgEnergy)) / 2).toFixed(1);
                document.getElementById('health-score').textContent = `${score}/10`;
            }

            // Cargar actividad reciente
            await this.loadRecentActivity();

            // Cargar gr√°fico de tendencias
            this.createTrendsChart();

        } catch (error) {
            console.error('Error cargando dashboard:', error);
        }
    }

    async loadRecentActivity() {
        const container = document.getElementById('recent-activity');
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        try {
            const [todayData, yesterdayData] = await Promise.all([
                db.getDailyMetrics(today),
                db.getDailyMetrics(yesterday)
            ]);

            let html = '';

            // Actividades de hoy
            if (todayData.sleep) {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-time">Hoy - ${todayData.sleep.wakeTime}</div>
                        <div class="timeline-content">
                            üò¥ Registrado sue√±o: ${Math.floor(todayData.sleep.duration / 60)}h ${todayData.sleep.duration % 60}m
                            <br>Calidad: ${todayData.sleep.quality}/10
                        </div>
                    </div>
                `;
            }

            if (todayData.exercise.length > 0) {
                todayData.exercise.forEach(ex => {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-time">Hoy - ${ex.timestamp.split('T')[1].slice(0, 5)}</div>
                            <div class="timeline-content">
                                üèÉ Ejercicio ${ex.type}: ${ex.duration} min
                                <br>Intensidad: ${ex.intensity}
                            </div>
                        </div>
                    `;
                });
            }

            // Actividades de ayer
            if (yesterdayData.sleep) {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-time">Ayer - ${yesterdayData.sleep.wakeTime}</div>
                        <div class="timeline-content">
                            üò¥ Sue√±o: ${Math.floor(yesterdayData.sleep.duration / 60)}h ${yesterdayData.sleep.duration % 60}m
                        </div>
                    </div>
                `;
            }

            if (html === '') {
                html = '<p style="color: #64748b;">No hay actividad reciente. ¬°Comienza a registrar tus datos!</p>';
            }

            container.innerHTML = html;

        } catch (error) {
            console.error('Error cargando actividad reciente:', error);
            container.innerHTML = '<p style="color: #ef4444;">Error cargando actividad</p>';
        }
    }

    createTrendsChart() {
        const canvas = document.getElementById('trends-chart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        // Datos de ejemplo (en producci√≥n vendr√≠an de la DB)
        const data = {
            labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
            sleep: [7.5, 8, 7, 7.5, 8, 7.5, 8],
            quality: [8, 7, 6, 8, 9, 7, 8]
        };

        this.drawLineChart(ctx, data, canvas.width, canvas.height);
    }

    drawLineChart(ctx, data, width, height) {
        ctx.clearRect(0, 0, width, height);

        const padding = 40;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;

        // Dibujar ejes
        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 1;

        // Eje Y
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.stroke();

        // Eje X
        ctx.beginPath();
        ctx.moveTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();

        // Dibujar l√≠neas de sue√±o
        ctx.strokeStyle = '#2563eb';
        ctx.lineWidth = 3;
        ctx.beginPath();

        data.sleep.forEach((value, index) => {
            const x = padding + (chartWidth / (data.sleep.length - 1)) * index;
            const y = height - padding - (value / 10) * chartHeight;

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });

        ctx.stroke();

        // Dibujar puntos
        ctx.fillStyle = '#2563eb';
        data.sleep.forEach((value, index) => {
            const x = padding + (chartWidth / (data.sleep.length - 1)) * index;
            const y = height - padding - (value / 10) * chartHeight;

            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
        });

        // Dibujar etiquetas X
        ctx.fillStyle = '#64748b';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';

        data.labels.forEach((label, index) => {
            const x = padding + (chartWidth / (data.labels.length - 1)) * index;
            ctx.fillText(label, x, height - padding + 20);
        });

        // T√≠tulo
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold 14px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('Horas de Sue√±o', padding, padding - 15);
    }

    // ==================== MODALES Y FORMULARIOS ====================
    async logSleep() {
        const modalBody = document.getElementById('modal-body');
        document.getElementById('modal-title').textContent = 'Registrar Sue√±o';

        modalBody.innerHTML = `
            <form id="sleep-form" class="form-grid">
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" name="date" class="form-input" value="${new Date().toISOString().split('T')[0]}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Hora de dormir</label>
                    <input type="time" name="bedTime" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Hora de despertar</label>
                    <input type="time" name="wakeTime" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Calidad del sue√±o (1-10)</label>
                    <input type="range" name="quality" min="1" max="10" value="7" class="form-input" oninput="this.nextElementSibling.textContent = this.value">
                    <span style="font-weight: bold; color: var(--primary);">7</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Interrupciones</label>
                    <input type="number" name="interruptions" min="0" class="form-input" value="0">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label">Notas</label>
                    <textarea name="notes" class="form-textarea" placeholder="¬øC√≥mo te sentiste al despertar?"></textarea>
                </div>
                <div style="grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        `;

        document.getElementById('sleep-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const bedTime = formData.get('bedTime');
            const wakeTime = formData.get('wakeTime');

            // Calcular duraci√≥n
            const [bedHour, bedMin] = bedTime.split(':').map(Number);
            const [wakeHour, wakeMin] = wakeTime.split(':').map(Number);

            let duration = (wakeHour * 60 + wakeMin) - (bedHour * 60 + bedMin);
            if (duration < 0) duration += 24 * 60; // Si cruz√≥ medianoche

            await db.addSleepLog({
                date: formData.get('date'),
                bedTime,
                wakeTime,
                duration,
                quality: parseInt(formData.get('quality')),
                interruptions: parseInt(formData.get('interruptions')),
                notes: formData.get('notes')
            });

            this.closeModal();
            this.showNotification('Registro de sue√±o guardado', 'success');
            await this.loadDashboard();
        });

        this.openModal();
    }

    async logSupplements() {
        const modalBody = document.getElementById('modal-body');
        document.getElementById('modal-title').textContent = 'Registrar Suplementos';

        const supplements = [
            'Melatonina 1-3mg',
            'Vitamina D3 2000-4000 IU',
            'Magnesio 200-400mg',
            'Omega-3 1-2g',
            'NAC 600mg',
            'Taurina 1-2g',
            'L-Teanina 200mg',
            'Vitamina B Complex'
        ];

        modalBody.innerHTML = `
            <form id="supplement-form">
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" name="date" class="form-input" value="${new Date().toISOString().split('T')[0]}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Hora</label>
                    <input type="time" name="time" class="form-input" value="${new Date().toTimeString().slice(0, 5)}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Suplementos tomados</label>
                    ${supplements.map(supp => `
                        <div style="margin: 8px 0;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="supplements" value="${supp}">
                                <span>${supp}</span>
                            </label>
                        </div>
                    `).join('')}
                </div>
                <div class="form-group">
                    <label class="form-label">Notas</label>
                    <textarea name="notes" class="form-textarea" placeholder="Efectos o comentarios"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        `;

        document.getElementById('supplement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const selectedSupplements = formData.getAll('supplements');

            await db.addSupplementLog({
                date: formData.get('date'),
                time: formData.get('time'),
                supplements: selectedSupplements,
                taken: selectedSupplements.length > 0,
                notes: formData.get('notes')
            });

            this.closeModal();
            this.showNotification('Suplementos registrados', 'success');
            await this.loadDashboard();
        });

        this.openModal();
    }

    async logExercise() {
        const modalBody = document.getElementById('modal-body');
        document.getElementById('modal-title').textContent = 'Registrar Ejercicio';

        modalBody.innerHTML = `
            <form id="exercise-form" class="form-grid">
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" name="date" class="form-input" value="${new Date().toISOString().split('T')[0]}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de ejercicio</label>
                    <select name="type" class="form-select" required>
                        <option value="cardio">Cardio</option>
                        <option value="strength">Fuerza</option>
                        <option value="flexibility">Flexibilidad</option>
                        <option value="mixed">Mixto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Duraci√≥n (minutos)</label>
                    <input type="number" name="duration" min="1" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Intensidad</label>
                    <select name="intensity" class="form-select" required>
                        <option value="low">Baja</option>
                        <option value="medium">Media</option>
                        <option value="high">Alta</option>
                    </select>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label">Notas</label>
                    <textarea name="notes" class="form-textarea" placeholder="Detalles del ejercicio"></textarea>
                </div>
                <div style="grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        `;

        document.getElementById('exercise-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            await db.addExerciseLog({
                date: formData.get('date'),
                type: formData.get('type'),
                duration: parseInt(formData.get('duration')),
                intensity: formData.get('intensity'),
                notes: formData.get('notes')
            });

            this.closeModal();
            this.showNotification('Ejercicio registrado', 'success');
            await this.loadDashboard();
        });

        this.openModal();
    }

    async logHealth() {
        const modalBody = document.getElementById('modal-body');
        document.getElementById('modal-title').textContent = 'M√©tricas de Salud';

        modalBody.innerHTML = `
            <form id="health-form" class="form-grid">
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" name="date" class="form-input" value="${new Date().toISOString().split('T')[0]}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Peso (kg)</label>
                    <input type="number" step="0.1" name="weight" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Presi√≥n Sist√≥lica</label>
                    <input type="number" name="systolic" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Presi√≥n Diast√≥lica</label>
                    <input type="number" name="diastolic" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Frecuencia Card√≠aca</label>
                    <input type="number" name="heartRate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Estado de √°nimo (1-10)</label>
                    <input type="range" name="mood" min="1" max="10" value="7" class="form-input" oninput="this.nextElementSibling.textContent = this.value">
                    <span style="font-weight: bold; color: var(--primary);">7</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Energ√≠a (1-10)</label>
                    <input type="range" name="energy" min="1" max="10" value="7" class="form-input" oninput="this.nextElementSibling.textContent = this.value">
                    <span style="font-weight: bold; color: var(--primary);">7</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Estr√©s (1-10)</label>
                    <input type="range" name="stress" min="1" max="10" value="5" class="form-input" oninput="this.nextElementSibling.textContent = this.value">
                    <span style="font-weight: bold; color: var(--primary);">5</span>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label">S√≠ntomas</label>
                    <textarea name="symptoms" class="form-textarea" placeholder="Describe cualquier s√≠ntoma (dolor de cabeza, fatiga, etc.)"></textarea>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label">Notas</label>
                    <textarea name="notes" class="form-textarea" placeholder="Observaciones adicionales"></textarea>
                </div>
                <div style="grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        `;

        document.getElementById('health-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const systolic = formData.get('systolic');
            const diastolic = formData.get('diastolic');

            await db.addHealthLog({
                date: formData.get('date'),
                weight: formData.get('weight') ? parseFloat(formData.get('weight')) : null,
                bloodPressure: systolic && diastolic ? {
                    systolic: parseInt(systolic),
                    diastolic: parseInt(diastolic)
                } : null,
                heartRate: formData.get('heartRate') ? parseInt(formData.get('heartRate')) : null,
                mood: parseInt(formData.get('mood')),
                energy: parseInt(formData.get('energy')),
                stress: parseInt(formData.get('stress')),
                symptoms: formData.get('symptoms') ? formData.get('symptoms').split(',').map(s => s.trim()) : [],
                notes: formData.get('notes')
            });

            this.closeModal();
            this.showNotification('M√©tricas de salud guardadas', 'success');
            await this.loadDashboard();
        });

        this.openModal();
    }

    // ==================== EXPORTACI√ìN ====================
    async exportData() {
        try {
            const data = await db.exportAllData();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `protocolo-circadiano-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            this.showNotification('Datos exportados exitosamente', 'success');
        } catch (error) {
            console.error('Error exportando datos:', error);
            this.showNotification('Error al exportar datos', 'error');
        }
    }

    // ==================== VISTAS ADICIONALES ====================
    async loadSleepView() {
        // Implementaci√≥n completa de vista de sue√±o
        const view = document.getElementById('sleep-view');
        view.innerHTML = '<div class="spinner"></div>';

        setTimeout(() => {
            view.innerHTML = `
                <div class="content-section">
                    <div class="section-header">
                        <h3 class="section-title">Historial de Sue√±o</h3>
                        <button class="btn btn-primary" onclick="app.logSleep()">+ Registrar Sue√±o</button>
                    </div>
                    <p>Vista de historial de sue√±o en desarrollo...</p>
                </div>
            `;
        }, 500);
    }

    async loadProtocolView() {
        const view = document.getElementById('protocol-view');
        view.innerHTML = `
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Tu Protocolo Circadiano</h3>
                </div>
                <p style="margin-bottom: 20px;">Protocolo personalizado para horario 23:00 - 07:00 hrs</p>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">07:00 - 07:30</div>
                        <div class="timeline-content">
                            <strong>üï∂Ô∏è Regreso con protecci√≥n</strong><br>
                            Usa gafas oscuras, evita luz solar directa
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">08:30 - 16:30</div>
                        <div class="timeline-content">
                            <strong>üò¥ SUE√ëO PRINCIPAL (8h)</strong><br>
                            Oscuridad total, 16-19¬∞C, silencio
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">18:00 - 19:00</div>
                        <div class="timeline-content">
                            <strong>üèÉ Ejercicio moderado</strong><br>
                            30-40 min cardio, preferiblemente con luz natural
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">23:00 - 07:00</div>
                        <div class="timeline-content">
                            <strong>üíº TURNO DE TRABAJO</strong><br>
                            Luz brillante >1000 lux, cafe√≠na estrat√©gica
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async loadSettingsView() {
        const view = document.getElementById('settings-view');
        view.innerHTML = `
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Configuraci√≥n</h3>
                </div>
                <div class="form-group">
                    <label class="form-label">Notificaciones del navegador</label>
                    <button class="btn btn-primary" onclick="app.requestNotificationPermission()">Activar Notificaciones</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Importar datos</label>
                    <input type="file" accept=".json" id="import-file" class="form-input">
                    <button class="btn btn-secondary" onclick="app.importData()">Importar</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Gesti√≥n de datos</label>
                    <button class="btn btn-secondary" onclick="app.exportData()">Exportar Datos</button>
                    <button class="btn" style="background: #ef4444; color: white;" onclick="app.clearAllData()">Limpiar Todos los Datos</button>
                </div>
            </div>
        `;
    }

    // ==================== UTILIDADES ====================
    openModal() {
        document.getElementById('modal').classList.add('active');
    }

    closeModal() {
        document.getElementById('modal').classList.remove('active');
    }

    showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const content = document.getElementById('notification-content');

        content.textContent = message;
        notification.className = `notification ${type} show`;

        if (this.notificationTimeout) {
            clearTimeout(this.notificationTimeout);
        }

        this.notificationTimeout = setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    async requestNotificationPermission() {
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                this.showNotification('Notificaciones activadas', 'success');
            }
        }
    }

    async checkNotifications() {
        // Verificar si es hora de recordatorios
        const now = new Date();
        const hour = now.getHours();

        // Recordatorio de suplementos matutinos (08:00)
        if (hour === 8 && now.getMinutes() < 5) {
            this.sendNotification('Hora de tomar suplementos matutinos', 'Melatonina, Magnesio antes de dormir');
        }

        // Recordatorio de ejercicio (18:00)
        if (hour === 18 && now.getMinutes() < 5) {
            this.sendNotification('Hora de ejercicio', '30-40 min de actividad f√≠sica');
        }
    }

    sendNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body,
                icon: 'üåô',
                badge: 'üåô'
            });
        }
    }

    showQuickLog() {
        // Mostrar men√∫ r√°pido de registro
        this.logSleep();
    }

    async clearAllData() {
        if (confirm('¬øEst√°s seguro de que quieres eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
            await db.clearAll();
            this.showNotification('Todos los datos han sido eliminados', 'success');
            await this.loadDashboard();
        }
    }

    viewAll(type) {
        // Implementar navegaci√≥n a vista completa
        console.log('Ver todo:', type);
    }
}

// Inicializar aplicaci√≥n
const app = new CircadianApp();

// Cargar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => app.init());
} else {
    app.init();
}
    </script>
</body>
</html>
